<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scan Barcode Kamera</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    #video {
      width: 100%;
      max-width: 640px;
      border: 2px solid #007BFF;
      border-radius: 12px;
      margin: 20px auto;
      display: block;
    }

    #status {
      font-size: 1.1em;
      margin: 15px 0;
      color: #333;
      font-weight: 500;
    }

    #startBtn {
      background: #007BFF;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }

    #startBtn:hover {
      background: #0056b3;
    }

    #startBtn.hidden {
      display: none;
    }

    .error {
      color: #d32f2f;
      font-weight: bold;
    }

    .success {
      color: #388e3c;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>üîç Scan Barcode dengan Kamera</h1>
  <video id="video" autoplay playsinline></video>
  <p id="status">Memuat kamera...</p>

  <button id="startBtn">üîç Mulai Scan</button>

  <!-- ZXing.js untuk scan barcode -->
  <script src="https://unpkg.com/@zxing/library@latest/dist/index.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');

    let stream;
    const codeReader = new ZXing.BrowserMultiFormatReader();

    // Tampilkan pesan error jelas
    function showStatus(text, isError = false) {
      statusDiv.textContent = text;
      statusDiv.className = isError ? 'error' : 'success';
    }

    // Mulai scanning
    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      startBtn.textContent = "üîç Memulai...";

      try {
        // Coba kamera belakang dulu
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "environment"
          }
        });

        video.srcObject = stream;
        showStatus("‚úÖ Kamera belakang aktif. Scan sedang berjalan...");

        // Mulai scan barcode
        await codeReader.decodeFromVideoDevice(
          null, // kamera default (bisa pilih manual jika butuh)
          video,
          (result, err) => {
            if (result) {
              showStatus(`üéâ Barcode terbaca: ${result.getText()}`, false);
              console.log("Barcode:", result.getText());
              // Hentikan scan setelah ditemukan
              codeReader.reset();
            } else if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error("Error saat scan:", err);
              // Coba fallback ke kamera depan
              fallbackToUserCamera();
            }
          }
        );

      } catch (err) {
        console.error("‚ùå Kamera belakang gagal:", err);
        showStatus("üö´ Kamera belakang tidak tersedia. Coba kamera depan...");
        await fallbackToUserCamera();
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = "üîç Mulai Scan";
      }
    });

    // Fallback: Gunakan kamera depan
    async function fallbackToUserCamera() {
      try {
        const frontStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "user"
          }
        });

        video.srcObject = frontStream;
        showStatus("üìå Fallback ke kamera depan berhasil. Scan berjalan...");

        // Lanjutkan scan
        await codeReader.decodeFromVideoDevice(
          null,
          video,
          (result, err) => {
            if (result) {
              showStatus(`üéâ Barcode terbaca: ${result.getText()}`, false);
              console.log("Barcode:", result.getText());
              codeReader.reset();
            } else if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error("Error saat scan:", err);
            }
          }
        );

      } catch (err2) {
        console.error("‚ùå Kamera depan juga gagal:", err2);
        showStatus("‚ùå Kamera tidak tersedia atau diblokir. Pastikan: <br>1. Gunakan HTTPS <br>2. Izinkan akses kamera di browser.", true);
        startBtn.classList.add("hidden");
      }
    }

    // Handle video close
    video.addEventListener('loadedmetadata', () => {
      video.play().catch(err => {
        console.error("Video play error:", err);
        showStatus("‚ùå Tidak bisa memutar video. Pastikan browser mengizinkan akses kamera.", true);
      });
    });
  </script>

</body>
</html>
